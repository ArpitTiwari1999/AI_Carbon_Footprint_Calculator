<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Footprint Journey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Calm Harmony (Base: Stone, Accent: Emerald) -->
    <!-- Application Structure Plan: A multi-step questionnaire guided by a central, evolving doodle (AI Sprout) and an interactive guide character. Each question prompts a unique interaction, influencing the doodle's appearance and the final carbon footprint calculation. The flow moves from an intro, through questions, to a dynamic results page with equivalencies, personalized tips, and detailed calculation explanations. -->
    <!-- Visualization & Content Choices:
        - Interactive Doodle (SVG/JS): Central visual element, grows/changes color/animates based on user answers and total footprint. Reflects "health" of AI usage.
        - Creative Question Prompts (HTML/JS): Questions are framed as engaging scenarios, not simple queries.
        - Animated Transitions (CSS/JS): Smooth fades, slides, and pop-ins for questions, doodle changes, and results.
        - Dynamic Calculation (JS): Real-time calculation based on user input, updating visual state.
        - Carbon/Water Equivalents (HTML/JS): Results presented with relatable real-world comparisons.
        - LLM-powered Explanation (Gemini API): Provides detailed, personalized explanation of calculation in a modal.
        - LLM-powered Green Strategy (Gemini API): Generates tailored tips.
        - Interactive Guide Character (SVG/JS/CSS): A stylized 2D character (simulating 3D with transforms) that moves with the cursor, transitions with questions, and offers LLM-powered question explanations.
        - CONFIRMATION: NO SVG graphics used for complex charting (only simple doodle and character). NO Mermaid JS used. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevent horizontal scrolling */
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23059669" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right-circle"><circle cx="12" cy="12" r="10"></circle><polyline points="12 16 16 12 12 8"></polyline><line x1="8" y1="12" x2="16" y2="12"></line></svg>') 12 12, auto;
        }
        .container {
            max-width: 100vw;
            overflow-x: hidden;
        }
        .question-section {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            opacity: 0;
            transform: translateX(100%);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .question-section.active {
            opacity: 1;
            transform: translateX(0%);
            position: relative;
        }
        .question-section.hidden {
            display: none;
        }
        .question-section.slide-out {
            transform: translateX(-100%);
            opacity: 0;
        }
        .option-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .option-card.selected {
            border-color: #059669; /* emerald-600 */
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.5);
            background-color: #D1FAE5; /* emerald-100 */
        }
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: #059669; /* emerald-600 */
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background 0.15s ease-in-out;
        }
        .slider-thumb::-moz-range-thumb {
            width: 25px;
            height: 25px;
            background: #059669;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background 0.15s ease-in-out;
        }
        /* Doodle specific SVG styling for animation */
        #sprout-stem {
            transition: all 0.5s ease-in-out;
            transform-origin: bottom center;
        }
        .sprout-leaf {
            transition: all 0.5s ease-in-out;
            transform-origin: center center;
        }
        .sprout-spark {
            animation: pulse-spark 1.5s infinite ease-in-out;
            opacity: 0;
            transform: scale(0);
        }
        @keyframes pulse-spark {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0); }
        }
        .doodle-container {
            width: 200px;
            height: 200px;
            margin: 0 auto 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .results-section {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }
        .results-section.active {
            opacity: 1;
            transform: translateY(0);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 700px; /* Increased max-width for better readability */
            position: relative;
            max-height: 85vh; /* Increased max-height */
            overflow-y: auto;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #059669;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Guide Character Styling */
        #guide-character-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 900;
            width: 80px; /* Base size */
            height: 80px;
            transition: transform 0.1s ease-out; /* Smooth movement */
            cursor: pointer;
        }
        #guide-character-info-btn {
            position: absolute;
            top: -10px;
            left: -10px;
            background-color: #f87171; /* red-400 */
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 901;
            transition: transform 0.1s ease;
        }
        #guide-character-info-btn:hover {
            transform: scale(1.1);
        }

        /* Character head bounce animation */
        @keyframes head-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        #character-head {
            animation: head-bounce 2s infinite ease-in-out;
            transform-origin: center bottom;
        }

        /* Responsive adjustments for character */
        @media (max-width: 768px) {
            #guide-character-container {
                width: 60px;
                height: 60px;
                bottom: 10px;
                right: 10px;
            }
            #guide-character-info-btn {
                width: 20px;
                height: 20px;
                font-size: 0.6rem;
                top: -5px;
                left: -5px;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-stone-100 to-stone-200 text-stone-800 min-h-screen flex flex-col items-center justify-center p-4">

    <div id="calculator-container" class="bg-white rounded-xl shadow-2xl p-6 md:p-8 lg:p-10 w-full max-w-lg mx-auto my-8 relative overflow-hidden min-h-[600px] flex flex-col justify-between">
        
        <div id="intro-screen" class="question-section active text-center">
            <h2 class="text-4xl font-extrabold text-emerald-700 mb-6">AI Footprint Journey</h2>
            <div class="doodle-container">
                <svg id="ai-sprout-doodle" viewBox="0 0 100 100" class="w-full h-full">
                    <circle id="sprout-pot" cx="50" cy="90" r="15" fill="#a8a29e" stroke="#78716c" stroke-width="2"/>
                    <path id="sprout-stem" d="M50 75 Q45 50 50 30 Q55 50 50 75" fill="#a8a29e" stroke="#78716c" stroke-width="2"/>
                    <circle id="sprout-core" cx="50" cy="30" r="5" fill="#4ade80" stroke="#16a34a" stroke-width="1"/>
                    <g id="sprout-leaves-group">
                        <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(0 50 30) scale(0)"/>
                        <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(72 50 30) scale(0)"/>
                        <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(144 50 30) scale(0)"/>
                        <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(216 50 30) scale(0)"/>
                        <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(288 50 30) scale(0)"/>
                    </g>
                    <circle class="sprout-spark" cx="60" cy="20" r="2" fill="yellow"/>
                    <circle class="sprout-spark" cx="40" cy="25" r="2" fill="orange"/>
                </svg>
            </div>
            <p class="text-lg leading-relaxed text-stone-700 mb-8">Ever wondered about the hidden footsteps of your digital companions? Let's uncover your AI Footprint!</p>
            <button id="start-journey" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105">
                Start Journey!
            </button>
        </div>

        <div id="questions-container" class="relative flex-grow flex flex-col justify-center items-center">
            <!-- Questions will be dynamically loaded here -->
        </div>

        <div id="results-screen" class="question-section hidden text-center">
            <h2 class="text-4xl font-extrabold text-emerald-700 mb-6">Your AI Footprint</h2>
            <div class="doodle-container">
                <svg id="final-sprout-doodle" viewBox="0 0 100 100" class="w-full h-full">
                    <circle id="final-sprout-pot" cx="50" cy="90" r="15" fill="#a8a29e" stroke="#78716c" stroke-width="2"/>
                    <path id="final-sprout-stem" d="M50 75 Q45 50 50 30 Q55 50 50 75" fill="#a8a29e" stroke="#78716c" stroke-width="2"/>
                    <circle id="final-sprout-core" cx="50" cy="30" r="5" fill="#4ade80" stroke="#16a34a" stroke-width="1"/>
                    <g id="final-sprout-leaves-group">
                        <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(0 50 30) scale(0)"/>
                        <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(72 50 30) scale(0)"/>
                        <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(144 50 30) scale(0)"/>
                        <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(216 50 30) scale(0)"/>
                        <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(288 50 30) scale(0)"/>
                    </g>
                </svg>
            </div>
            <p id="result-text" class="text-xl font-semibold text-stone-700 mb-4"></p>
            
            <div class="bg-emerald-50 p-6 rounded-lg shadow-inner w-full mb-6">
                <h3 class="text-xl font-bold text-emerald-700 mb-3">Your Annual Impact:</h3>
                <p class="text-lg mb-2"><strong id="total-co2e" class="text-emerald-800"></strong> CO2e (Carbon Dioxide Equivalent)</p>
                <p class="text-lg mb-4"><strong id="total-water" class="text-emerald-800"></strong> Liters of Water</p>

                <h4 class="text-lg font-semibold text-stone-700 mb-2">That's like...</h4>
                <ul class="list-disc list-inside text-sm text-stone-600 space-y-1">
                    <li id="co2e-equiv-car"></li>
                    <li id="co2e-equiv-phone"></li>
                    <li id="water-equiv-shower"></li>
                    <li id="water-equiv-flush"></li>
                </ul>
            </div>
            
            <h3 class="text-2xl font-bold text-emerald-600 mb-3">Small Steps, Big Impact:</h3>
            <ul id="tips-list" class="list-disc list-inside text-sm text-stone-700 text-left w-full mx-auto md:w-4/5 lg:w-3/4 space-y-2">
                <!-- Tips will be dynamically loaded here -->
            </ul>

            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-6 w-full">
                <button id="show-calc-modal-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                    📊 How It's Calculated
                </button>
                <button id="deep-dive-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                    ✨ Deep Dive Footprint
                    <div id="deep-dive-spinner" class="loading-spinner ml-2 hidden"></div>
                </button>
                <button id="green-strategy-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105 flex items-center justify-center">
                    🌿 Green Strategy Spark
                    <div id="green-strategy-spinner" class="loading-spinner ml-2 hidden"></div>
                </button>
            </div>
            
            <button id="restart-journey" class="mt-8 bg-stone-600 hover:bg-stone-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105">
                Restart Journey
            </button>
        </div>

    </div>

    <!-- Modal for Deep Dive Explanation / Question Info / Calculation Explanation -->
    <div id="info-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="modal-close-button">&times;</span>
            <h3 class="text-2xl font-bold text-emerald-700 mb-4" id="modal-title"></h3>
            <div id="modal-content-area" class="text-stone-700 leading-relaxed text-sm">
                <!-- Content generated by LLM or static calculation breakdown -->
            </div>
        </div>
    </div>

    <!-- Animated Guide Character -->
    <div id="guide-character-container">
        <button id="guide-character-info-btn">i</button>
        <svg viewBox="0 0 100 100" class="w-full h-full" id="guide-character-svg">
            <!-- Body -->
            <rect x="30" y="50" width="40" height="40" rx="10" ry="10" fill="#a8a29e" stroke="#78716c" stroke-width="2"/>
            <!-- Arms -->
            <rect x="20" y="55" width="10" height="20" rx="5" ry="5" fill="#a8a29e" stroke="#78716c" stroke-width="2" transform="rotate(-15 20 55)"/>
            <rect x="70" y="55" width="10" height="20" rx="5" ry="5" fill="#a8a29e" stroke="#78716c" stroke-width="2" transform="rotate(15 80 55)"/>
            <!-- Head - Animated -->
            <g id="character-head">
                <circle cx="50" cy="35" r="20" fill="#fcd34d" stroke="#d97706" stroke-width="2"/> <!-- Skin tone -->
                <!-- Hair/Beard - Simplified, inspired by image -->
                <path d="M40 15 Q50 5 60 15 Q65 25 60 30 Q50 35 40 30 Q35 25 40 15 Z" fill="#4a5568" stroke="#2d3748" stroke-width="1"/> <!-- Top Hair -->
                <path d="M40 45 Q45 55 50 50 Q55 55 60 45 L60 35 L40 35 Z" fill="#4a5568" stroke="#2d3748" stroke-width="1"/> <!-- Beard -->
                <!-- Eyes -->
                <circle cx="43" cy="32" r="3" fill="white" stroke="black" stroke-width="1"/>
                <circle cx="57" cy="32" r="3" fill="white" stroke="black" stroke-width="1"/>
                <circle cx="43" cy="32" r="1" fill="black"/>
                <circle cx="57" cy="32" r="1" fill="black"/>
                <!-- Mouth (Smiling) -->
                <path d="M45 40 Q50 45 55 40" stroke="black" stroke-width="1" fill="none"/>
            </g>
        </svg>
    </div>


    <script>
        // --- Core Calculator Data & Logic ---
        const DEFAULT_QUERY_CO2E_G = 4.32; // grams CO2e per average query (Arbor.eco)
        const DEFAULT_QUERY_WATER_ML = 500; // ml water per average query (Investopedia)
        const KWH_TO_CO2E_KG_US_AVG = 0.367; // kg CO2e per kWh (WAB Learns, EIA 2024)
        const KG_TO_G = 1000;

        let userAnswers = {};
        let currentQuestionIndex = 0;
        let totalCO2e_g = 0;
        let totalWater_ml = 0;
        let intermediateCalculations = {}; // Store for calculation explanation modal

        const questions = [
            {
                id: 'daily_chatbot_usage',
                prompt: "Your AI assistant: How many daily chats?",
                full_prompt: "Imagine your AI assistant (like Gemini, ChatGPT, Claude) is a trusty messenger. How many quick notes or complex conversations do you typically send its way in a day?",
                type: 'slider',
                min: 0,
                max: 50,
                step: 1,
                labels: {
                    0: 'Rarely',
                    5: 'A few whispers',
                    20: 'Daily dialogues',
                    50: 'Deep dives'
                },
                question_specific_data: {
                    carbon_multiplier_per_query: 1.0,
                    water_multiplier_per_query: 1.0
                },
                get_value: (val) => parseFloat(val),
                reference: {
                    text: "Arbor.eco, 'AI's Environmental Impact: Calculated and Explained'",
                    url: "https://www.arbor.eco/blog/ai-environmental-impact"
                },
                tips_key: 'query_volume'
            },
            {
                id: 'creative_canvas_usage',
                prompt: "Creative AI: How often do you generate images or videos?",
                full_prompt: "Your AI can paint masterpieces and forge new worlds! How often do you ask it to conjure images or short videos?",
                type: 'choice',
                options: [
                    { value: 0, label: "Rarely", desc: "I'm more text-based." },
                    { value: 0.5, label: "Occasional", desc: "2-5 creations per week." },
                    { value: 2, label: "Daily", desc: "6+ creations per week." }
                ],
                question_specific_data: {
                    carbon_per_creation_g: 0.002 * KWH_TO_CO2E_KG_US_AVG * KG_TO_G, // 0.002 kWh per image, converted to grams CO2e (WAB Learns, HuggingFace)
                    water_per_creation_ml: 100 // Illustrative for more complex generation than simple query
                },
                get_value: (val) => parseFloat(val),
                reference: {
                    text: "#ALTC, 'Think before you prompt: Reduce your AI carbon footprint with ROCKS'",
                    url: "https://altc.alt.ac.uk/blog/2025/05/think-before-you-prompt-reduce-your-ai-carbon-footprint-with-rocks/"
                },
                tips_key: 'creative_usage'
            },
            {
                id: 'code_alchemist_usage',
                prompt: "Code Alchemist: How often do you use AI for coding?",
                full_prompt: "Does your AI speak in lines of code? How often do you enlist its help for coding, debugging, or script generation?",
                type: 'choice',
                options: [
                    { value: 0, label: "Novice", desc: "Just basic snippets." },
                    { value: 0.2, label: "Weekend", desc: "A few times a week." },
                    { value: 1, label: "Professional", desc: "Integral to my workflow daily." }
                ],
                question_specific_data: {
                    carbon_per_complex_query_g: 10, // Higher than simple text query, illustrative
                    water_per_complex_query_ml: 1000 // Illustrative
                },
                get_value: (val) => parseFloat(val),
                reference: {
                    text: "Extrapolated from LLM query costs; complex code generation implies more compute.",
                    url: "https://futurism.com/ai-energy-use" // General reference for LLM energy intensity
                },
                tips_key: 'coding_usage'
            },
            {
                id: 'data_center_location',
                prompt: "AI's Brain Home: Green or fossil-fueled region?",
                full_prompt: "Where do you imagine the invisible 'brain' powering your AI usually resides? Is it in a region known for green energy, or perhaps one more reliant on traditional sources?",
                type: 'choice',
                options: [
                    { value: 0.05, label: "Green Hub", desc: "Renewable-heavy (e.g., Quebec, Norway)." },
                    { value: KWH_TO_CO2E_KG_US_AVG, label: "Mixed Energy", desc: "Typical US energy mix." },
                    { value: 0.7, label: "Fossil-Fueled", desc: "Coal/gas heavy region." }
                ],
                get_value: (val) => parseFloat(val),
                reference: {
                    text: "WAB Learns, 'AI for Faculty: AI Footprints' (citing EIA 2024 for US, Statista for China proxy)",
                    url: "https://learn.wab.edu/innovation/ai/faculty/ethics/aifootprint"
                },
                tips_key: 'data_center'
            },
            {
                id: 'ai_model_size',
                prompt: "AI Model Size: Do you prefer compact or giant AI models?",
                full_prompt: "Do you prefer the giant, all-encompassing AI models, or are you gravitating towards smaller, more specialized ones? Think about the 'size' of the AI brain you usually consult.",
                type: 'choice',
                options: [
                    { value: 0.8, label: "Compact", desc: "Lighter, task-focused AIs." },
                    { value: 1.0, label: "Standard", desc: "Common commercial chatbots." },
                    { value: 1.5, label: "Giant", desc: "Cutting-edge, massive LLMs." }
                ],
                get_value: (val) => parseFloat(val),
                reference: {
                    text: "Fordham Law ELR, 'The Environmental Impact of AI: ChatGPT and Beyond'",
                    url: "https://fordhamlawelr.org/?p=1931"
                },
                tips_key: 'model_size'
            },
            {
                id: 'prompt_engineering_skill',
                prompt: "Prompting Skill: One-shot wonder or trial-and-error?",
                full_prompt: "Are you a master of crafting precise prompts, or do you tend to ask a lot of follow-up questions to get what you need? Think about how many 'tries' it takes to get your ideal AI response.",
                type: 'choice',
                options: [
                    { value: 0.9, label: "One-shot wonder", desc: "Precise prompting." },
                    { value: 1.1, label: "Iterative explorer", desc: "A few back-and-forths." },
                    { value: 1.3, label: "Trial-and-error maestro", desc: "Frequent adjustments." }
                ],
                get_value: (val) => parseFloat(val),
                reference: {
                    text: "#ALTC, 'Think before you prompt: Reduce your AI carbon footprint with ROCKS'",
                    url: "https://altc.alt.ac.uk/blog/2025/05/think-before-you-prompt-reduce-your-ai-carbon-footprint-with-rocks/"
                },
                tips_key: 'prompting'
            },
            {
                id: 'ai_always_on',
                prompt: "AI Apps Open: Do you leave AI tabs/apps open when idle?",
                full_prompt: "Do you leave AI-powered tabs or applications open even when not actively using them? Think of it like leaving a light on in an empty room.",
                type: 'choice',
                options: [
                    { value: 0, label: "Always Off", desc: "I close everything when not in use." },
                    { value: 0.1, label: "Sometimes On", desc: "I occasionally leave things open." },
                    { value: 0.2, label: "Always On", desc: "My browser often has AI tabs running." }
                ],
                get_value: (val) => parseFloat(val),
                reference: {
                    text: "General principle of background energy consumption by open applications and network connections.",
                    url: "https://source.android.com/docs/core/power/trackers" // Android OS reference for app background behavior
                },
                tips_key: 'always_on'
            },
            {
                id: 'device_used',
                prompt: "Primary AI Device: What device do you use most?",
                full_prompt: "The device you use to access AI also plays a part. What's your primary AI access device?",
                type: 'choice',
                options: [
                    { value: 0.005, label: "Smartphone/Tablet", desc: "Approx. 0.005 kWh/hr." },
                    { value: 0.07, label: "Standard Laptop/Desktop", desc: "Approx. 0.07 kWh/hr." },
                    { value: 0.2, label: "High-Performance PC", desc: "Approx. 0.2 kWh/hr." }
                ],
                question_specific_data: {
                    hours_per_day: 4 // Average active usage hours for device
                },
                get_value: (val) => parseFloat(val),
                reference: {
                    text: "WAB Learns, 'AI for Faculty: AI Footprints' (citing MacBook Pro 0.07kW/h)",
                    url: "https://learn.wab.edu/innovation/ai/faculty/ethics/aifootprint"
                },
                tips_key: 'device_type'
            },
            {
                id: 'activity_replaced',
                prompt: "AI's Offset: What activity does AI replace for you?",
                full_prompt: "Sometimes AI helps us avoid more carbon-intensive activities. What activity, if any, do you feel your AI usage *replaces* most often?",
                type: 'choice',
                options: [
                    { value: 0, label: "None directly", desc: "AI is an addition." },
                    { value: -20, label: "Manual research", desc: "Offset ~20 kg CO2e/year." },
                    { value: -50, label: "Travel for meetings", desc: "Offset ~50 kg CO2e/year." },
                    { value: -100, label: "Physical creation/testing", desc: "Offset ~100 kg CO2e/year." }
                ],
                get_value: (val) => parseFloat(val),
                reference: {
                    text: "Marmelab, 'AI's Environmental Impact: Making an Informed Choice'",
                    url: "https://marmelab.com/blog/2025/03/19/ai-carbon-footprint.html"
                },
                tips_key: 'offset_potential'
            },
            {
                id: 'digital_hygiene',
                prompt: "Digital Hygiene: How tidy is your digital life?",
                full_prompt: "Beyond AI, how conscious are you of your general digital habits? Do you regularly clear cache, minimize open tabs, and optimize your devices?",
                type: 'choice',
                options: [
                    { value: 0.95, label: "Minimalist", desc: "My digital space is always tidy." },
                    { value: 1.0, label: "Conscious", desc: "I try to optimize when I remember." },
                    { value: 1.05, label: "Hoarder", desc: "Hundreds of tabs open." }
                ],
                get_value: (val) => parseFloat(val),
                reference: {
                    text: "Rubryka, 'Ukrainian initiative on the forefront of digital cleanup'",
                    url: "https://rubryka.com/en/article/tsyfrove-prybyrannya/"
                },
                tips_key: 'digital_hygiene_level'
            }
        ];

        // --- DOM Elements ---
        const introScreen = document.getElementById('intro-screen');
        const startJourneyBtn = document.getElementById('start-journey');
        const questionsContainer = document.getElementById('questions-container');
        const resultsScreen = document.getElementById('results-screen');
        const restartJourneyBtn = document.getElementById('restart-journey');
        const showCalcModalBtn = document.getElementById('show-calc-modal-btn'); // New button
        const deepDiveBtn = document.getElementById('deep-dive-btn');
        const greenStrategyBtn = document.getElementById('green-strategy-btn');
        const deepDiveSpinner = document.getElementById('deep-dive-spinner');
        const greenStrategySpinner = document.getElementById('green-strategy-spinner');

        const sproutStem = document.getElementById('sprout-stem');
        const sproutLeaves = document.querySelectorAll('.sprout-leaf');
        const sproutCore = document.getElementById('sprout-core');
        const sproutSparks = document.querySelectorAll('.sprout-spark');

        const finalSproutStem = document.getElementById('final-sprout-stem');
        const finalSproutLeaves = document.querySelectorAll('#final-sprout-leaves-group .sprout-leaf');
        const finalSproutCore = document.getElementById('final-sprout-core');

        const totalCO2eEl = document.getElementById('total-co2e');
        const totalWaterEl = document.getElementById('total-water');
        const resultTextEl = document.getElementById('result-text');
        const co2eEquivCar = document.getElementById('co2e-equiv-car');
        const co2eEquivPhone = document.getElementById('co2e-equiv-phone');
        const waterEquivShower = document.getElementById('water-equiv-shower');
        const waterEquivFlush = document.getElementById('water-equiv-flush');
        const tipsList = document.getElementById('tips-list');

        const infoModal = document.getElementById('info-modal'); // Reusing for all modals
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalTitle = document.getElementById('modal-title');
        const modalContentArea = document.getElementById('modal-content-area');

        const guideCharacterContainer = document.getElementById('guide-character-container');
        const guideCharacterInfoBtn = document.getElementById('guide-character-info-btn');


        // --- Helper to get option label for LLM prompt ---
        function getOptionLabel(questionId, value) {
            const question = questions.find(q => q.id === questionId);
            if (!question) return String(value);

            if (question.type === 'choice') {
                const option = question.options.find(opt => String(opt.value) === String(value));
                return option ? (option.label_display || option.label) : String(value);
            } else if (question.type === 'slider') {
                const closestLabel = Object.keys(question.labels).reduce((prev, curr) => 
                    (Math.abs(curr - value) < Math.abs(prev - value) ? curr : prev)
                );
                return `${value} (${question.labels[closestLabel] || 'units'})`;
            }
            return String(value);
        }
        
        // --- Doodle Animation Control ---
        function updateDoodle(impactFactor) {
            const normalizedImpact = Math.min(1, Math.max(0, impactFactor / 500)); 
            
            const stemHeightScale = 1 - (normalizedImpact * 0.5); 
            if(sproutStem) sproutStem.style.transform = `scaleY(${stemHeightScale}) translateY(${50 * (1 - stemHeightScale)}px)`;
            if(sproutStem) sproutStem.style.fill = `rgb(${168 + normalizedImpact * 80}, ${162 - normalizedImpact * 100}, ${158 - normalizedImpact * 100})`; 

            sproutLeaves.forEach((leaf, index) => {
                const leafScale = 1 - (normalizedImpact * 0.8); 
                leaf.style.transform = `rotate(${index * 72}deg) scale(${leafScale})`;
                leaf.style.fill = `rgb(${74 - normalizedImpact * 50}, ${222 - normalizedImpact * 150}, ${128 - normalizedImpact * 80})`; 
            });

            sproutSparks.forEach(spark => {
                spark.style.opacity = (1 - normalizedImpact) > 0.5 ? 1 : 0;
                spark.style.transform = (1 - normalizedImpact) > 0.5 ? 'scale(1)' : 'scale(0)';
            });

            if(sproutCore) sproutCore.style.fill = `rgb(${74 + normalizedImpact * 100}, ${222 - normalizedImpact * 150}, ${128 - normalizedImpact * 80})`; 
        }

        function setFinalDoodleState(totalCO2e) {
            const normalizedImpact = Math.min(1, Math.max(0, totalCO2e / 500000)); 

            if(finalSproutStem) finalSproutStem.style.transform = `scaleY(${1 - (normalizedImpact * 0.5)}) translateY(${50 * (1 - (1 - (normalizedImpact * 0.5)))}px)`;
            if(finalSproutStem) finalSproutStem.style.fill = `rgb(${168 + normalizedImpact * 80}, ${162 - normalizedImpact * 100}, ${158 - normalizedImpact * 100})`;

            finalSproutLeaves.forEach((leaf, index) => {
                const leafScale = 1 - (normalizedImpact * 0.8);
                leaf.style.transform = `rotate(${index * 72}deg) scale(${leafScale})`;
                leaf.style.fill = `rgb(${74 - normalizedImpact * 50}, ${222 - normalizedImpact * 150}, ${128 - normalizedImpact * 80})`;
            });

            if(finalSproutCore) finalSproutCore.style.fill = `rgb(${74 + normalizedImpact * 100}, ${222 - normalizedImpact * 150}, ${128 - normalizedImpact * 80})`;

            document.querySelectorAll('#final-sprout-doodle .sprout-spark').forEach(spark => spark.style.display = 'none');
        }


        // --- Question Rendering ---
        function renderQuestion(question) {
            const currentSection = document.querySelector('.question-section.active');
            if (currentSection && currentSection !== introScreen) {
                currentSection.classList.remove('active');
                currentSection.classList.add('slide-out');
                setTimeout(() => {
                    currentSection.classList.add('hidden');
                    currentSection.remove();
                }, 500); // Wait for slide-out animation
            }

            const questionSection = document.createElement('div');
            questionSection.id = `question-${question.id}`;
            questionSection.className = 'question-section text-center p-4 md:p-6 lg:p-8 flex-grow overflow-y-auto'; // Added overflow-y-auto

            let optionsHtml = '';
            if (question.type === 'choice') {
                optionsHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 w-full max-w-md mx-auto">`;
                question.options.forEach(option => {
                    optionsHtml += `
                        <div class="option-card bg-white p-4 rounded-lg shadow-md cursor-pointer border-2 border-transparent" data-value="${option.value}">
                            <h4 class="font-semibold text-emerald-700">${option.label}</h4>
                            <p class="text-sm text-stone-600">${option.desc}</p>
                        </div>
                    `;
                });
                optionsHtml += `</div>`;
            } else if (question.type === 'slider') {
                optionsHtml = `
                    <div class="w-full max-w-md mx-auto mt-6">
                        <input type="range" min="${question.min}" max="${question.max}" value="${question.min}" step="${question.step}" 
                               class="w-full h-2 bg-stone-300 rounded-lg appearance-none cursor-pointer slider-thumb" id="slider-${question.id}">
                        <div class="flex justify-between text-xs text-stone-500 mt-2">
                            ${Object.keys(question.labels).map(key => `<span class="${parseInt(key) == question.min ? 'font-bold' : ''}">${question.labels[key] || key}</span>`).join('')}
                        </div>
                        <p id="slider-value-display" class="text-xl font-bold text-emerald-700 mt-4">${question.min} ${question.labels[question.min] ? question.labels[question.min] : 'units'}</p>
                    </div>
                `;
            }

            questionSection.innerHTML = `
                <div class="w-full h-full flex flex-col justify-center items-center">
                    <h3 class="text-2xl md:text-3xl font-bold text-emerald-700 mb-4 leading-snug">${question.prompt}</h3>
                    <div class="doodle-container">
                        <svg id="question-sprout-doodle" viewBox="0 0 100 100" class="w-full h-full">
                            <circle id="sprout-pot" cx="50" cy="90" r="15" fill="#a8a29e" stroke="#78716c" stroke-width="2"/>
                            <path id="sprout-stem" d="M50 75 Q45 50 50 30 Q55 50 50 75" fill="#a8a29e" stroke="#78716c" stroke-width="2"/>
                            <circle id="sprout-core" cx="50" cy="30" r="5" fill="#4ade80" stroke="#16a34a" stroke-width="1"/>
                            <g id="sprout-leaves-group">
                                <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(0 50 30) scale(0)"/>
                                <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(72 50 30) scale(0)"/>
                                <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(144 50 30) scale(0)"/>
                                <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(216 50 30) scale(0)"/>
                                <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(288 50 30) scale(0)"/>
                            </g>
                            <circle class="sprout-spark" cx="60" cy="20" r="2" fill="yellow"/>
                            <circle class="sprout-spark" cx="40" cy="25" r="2" fill="orange"/>
                        </svg>
                    </div>
                    ${optionsHtml}
                    <p class="text-xs text-stone-500 mt-4"><em>Reference: <a href="${question.reference.url}" target="_blank" class="text-emerald-600 hover:underline">${question.reference.text}</a></em></p>
                    <button id="next-question" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-full shadow-md mt-6 transition-all duration-300 transform hover:scale-105 opacity-50 cursor-not-allowed" disabled>Next</button>
                </div>
            `;

            questionsContainer.appendChild(questionSection);
            setTimeout(() => {
                questionSection.classList.add('active');
                updateDoodle(0); // Reset doodle for new question or small initial growth
            }, 100);


            const nextBtn = questionSection.querySelector('#next-question');
            let selectedValue = null;

            if (question.type === 'choice') {
                const optionCards = questionSection.querySelectorAll('.option-card');
                optionCards.forEach(card => {
                    card.addEventListener('click', () => {
                        optionCards.forEach(oc => oc.classList.remove('selected'));
                        card.classList.add('selected');
                        selectedValue = card.dataset.value;
                        nextBtn.disabled = false;
                        nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    });
                });
            } else if (question.type === 'slider') {
                const slider = questionSection.querySelector(`#slider-${question.id}`);
                const sliderValueDisplay = questionSection.querySelector('#slider-value-display');
                selectedValue = slider.value; // Set initial value
                nextBtn.disabled = false; // Slider always has a value
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');

                slider.addEventListener('input', () => {
                    selectedValue = slider.value;
                    const label = question.labels[selectedValue] || '';
                    sliderValueDisplay.textContent = `${selectedValue} ${label ? '(' + label + ')' : 'units'}`;
                    const tempCO2e = calculateFootprintForQuestion(question, selectedValue);
                    updateDoodle(tempCO2e);
                });
                const tempCO2e = calculateFootprintForQuestion(question, selectedValue);
                updateDoodle(tempCO2e);
            }

            nextBtn.addEventListener('click', () => {
                userAnswers[question.id] = question.get_value(selectedValue);
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    renderQuestion(questions[currentQuestionIndex]);
                } else {
                    calculateFinalFootprint();
                    displayResults();
                }
            });
        }

        function calculateFootprintForQuestion(question, answerValue) {
            let tempCO2e_g = 0;
            // This is a simplified preview calculation for the doodle, not the final one.
            if (question.id === 'daily_chatbot_usage') {
                tempCO2e_g = answerValue * DEFAULT_QUERY_CO2E_G;
            } else if (question.id === 'creative_canvas_usage') {
                tempCO2e_g = answerValue * questions[1].question_specific_data.carbon_per_creation_g;
            } else if (question.id === 'code_alchemist_usage') {
                tempCO2e_g = answerValue * questions[2].question_specific_data.carbon_per_complex_query_g;
            } else if (question.id === 'device_used') {
                tempCO2e_g = answerValue * questions[7].question_specific_data.hours_per_day * KWH_TO_CO2E_KG_US_AVG * KG_TO_G;
            }
            return tempCO2e_g;
        }


        function calculateFinalFootprint() {
            totalCO2e_g = 0;
            totalWater_ml = 0;
            intermediateCalculations = {}; // Reset intermediate calculations

            const dailyChatbotQueries = parseFloat(userAnswers['daily_chatbot_usage'] || 0);
            const creativeWeeklyCreations = parseFloat(userAnswers['creative_canvas_usage'] || 0);
            const codeDailyComplexQueries = parseFloat(userAnswers['code_alchemist_usage'] || 0);
            const dataCenterKGC02ePerKWh = parseFloat(userAnswers['data_center_location'] || KWH_TO_CO2E_KG_US_AVG);
            const aiModelSizeMultiplier = parseFloat(userAnswers['ai_model_size'] || 1.0);
            const promptEngineeringMultiplier = parseFloat(userAnswers['prompt_engineering_skill'] || 1.0);
            const aiAlwaysOnAdder = parseFloat(userAnswers['ai_always_on'] || 0);
            const deviceKWhPerHour = parseFloat(userAnswers['device_used'] || 0);
            const activityReplacedOffset_kg = parseFloat(userAnswers['activity_replaced'] || 0);
            const digitalHygieneMultiplier = parseFloat(userAnswers['digital_hygiene'] || 1.0);

            // --- Step-by-step calculation for modal ---
            intermediateCalculations.base = { co2e: 0, water: 0, description: "Starting point before any AI usage factors." };

            // 1. Chatbot queries
            const effectiveDailyQueries = dailyChatbotQueries * promptEngineeringMultiplier;
            const queryCO2e_g_per_day = effectiveDailyQueries * DEFAULT_QUERY_CO2E_G * aiModelSizeMultiplier;
            const queryWater_ml_per_day = effectiveDailyQueries * DEFAULT_QUERY_WATER_ML * aiModelSizeMultiplier;
            
            intermediateCalculations.chatbot = {
                co2e: queryCO2e_g_per_day * 365,
                water: queryWater_ml_per_day * 365,
                description: `From your chatbot queries (${dailyChatbotQueries} daily), adjusted by your prompting skill (${promptEngineeringMultiplier}x) and model size choice (${aiModelSizeMultiplier}x).`
            };

            // 2. Creative AI usage
            const creativeCO2e_g_per_day = (creativeWeeklyCreations / 7) * questions[1].question_specific_data.carbon_per_creation_g;
            const creativeWater_ml_per_day = (creativeWeeklyCreations / 7) * questions[1].question_specific_data.water_per_creation_ml;
            intermediateCalculations.creative = {
                co2e: creativeCO2e_g_per_day * 365,
                water: creativeWater_ml_per_day * 365,
                description: `From your creative AI use (${creativeWeeklyCreations} weekly creations).`
            };

            // 3. Coding AI usage
            const codingCO2e_g_per_day = codeDailyComplexQueries * questions[2].question_specific_data.carbon_per_complex_query_g;
            const codingWater_ml_per_day = codeDailyComplexQueries * questions[2].question_specific_data.water_per_complex_query_ml;
            intermediateCalculations.coding = {
                co2e: codingCO2e_g_per_day * 365,
                water: codingWater_ml_per_day * 365,
                description: `From your coding AI assistance (${codeDailyComplexQueries} daily complex queries).`
            };

            // 4. Device usage
            const deviceDailyKWh = deviceKWhPerHour * questions[7].question_specific_data.hours_per_day;
            const deviceCO2e_g_per_day = deviceDailyKWh * dataCenterKGC02ePerKWh * KG_TO_G; // Directly use selected data center intensity here
            intermediateCalculations.device = {
                co2e: deviceCO2e_g_per_day * 365,
                water: 0, // Simplified: device water consumption not separately calculated here.
                description: `From the energy consumed by your primary device (${getOptionLabel('device_used', userAnswers.device_used)}) to access AI.`
            };

            // Sum up preliminary annual totals
            let preliminaryAnnualCO2e_g = intermediateCalculations.chatbot.co2e + intermediateCalculations.creative.co2e + intermediateCalculations.coding.co2e + intermediateCalculations.device.co2e;
            let preliminaryAnnualWater_ml = intermediateCalculations.chatbot.water + intermediateCalculations.creative.water + intermediateCalculations.coding.water;

            intermediateCalculations.preliminarySum = {
                co2e: preliminaryAnnualCO2e_g,
                water: preliminaryAnnualWater_ml,
                description: "Sum of your direct AI tool and device operational impacts."
            };

            // 5. AI Always On overhead
            const alwaysOnCO2e_g = preliminaryAnnualCO2e_g * aiAlwaysOnAdder;
            const alwaysOnWater_ml = preliminaryAnnualWater_ml * aiAlwaysOnAdder;
            preliminaryAnnualCO2e_g += alwaysOnCO2e_g;
            preliminaryAnnualWater_ml += alwaysOnWater_ml;
            intermediateCalculations.alwaysOn = {
                co2e: alwaysOnCO2e_g,
                water: alwaysOnWater_ml,
                description: `Additional impact from leaving AI-powered apps open when idle (${aiAlwaysOnAdder*100}% of direct usage).`
            };

            // 6. Data Center Location Scaling (re-apply to operational CO2e if initial default was used for query, etc.)
            // NOTE: For more precision, all kWh calculations should use the dataCenterKGC02ePerKWh.
            // Current setup: default query CO2e is fixed, then scaled by location. Device is already by location.
            // Let's re-calculate total operational kWh, then apply `dataCenterKGC02ePerKWh`
            const totalOperationalKWh_annual = (queryCO2e_g_per_day / (DEFAULT_QUERY_CO2E_G * aiModelSizeMultiplier)) * (DEFAULT_QUERY_CO2E_G / (KWH_TO_CO2E_KG_US_AVG * KG_TO_G)) * 365 + // Chatbot kWh
                                                (creativeCO2e_g_per_day / questions[1].question_specific_data.carbon_per_creation_g) * (questions[1].question_specific_data.carbon_per_creation_g / (KWH_TO_CO2E_KG_US_AVG * KG_TO_G)) * 365 + // Creative kWh
                                                (codingCO2e_g_per_day / questions[2].question_specific_data.carbon_per_complex_query_g) * (questions[2].question_specific_data.carbon_per_complex_query_g / (KWH_TO_CO2E_KG_US_AVG * KG_TO_G)) * 365 + // Coding kWh
                                                (deviceDailyKWh * 365); // Device kWh
            
            const scaledOperationalCO2e_g = totalOperationalKWh_annual * dataCenterKGC02ePerKWh * KG_TO_G;
            intermediateCalculations.dataCenterScaling = {
                co2e: scaledOperationalCO2e_g - preliminaryAnnualCO2e_g, // Difference due to scaling
                description: `Adjusting for the carbon intensity of your chosen data center region (${getOptionLabel('data_center_location', userAnswers.data_center_location)}).`
            };
            preliminaryAnnualCO2e_g = scaledOperationalCO2e_g; // Update total with scaled value

            // 7. Embodied Carbon
            const embodiedCarbon_kg_per_year = 50; // Constant assumption
            preliminaryAnnualCO2e_g += (embodiedCarbon_kg_per_year * KG_TO_G);
            intermediateCalculations.embodiedCarbon = {
                co2e: (embodiedCarbon_kg_per_year * KG_TO_G),
                description: `Impact from the manufacturing and disposal of AI hardware (${embodiedCarbon_kg_per_year} kg CO2e annually, a simplified allocation).`
            };

            // 8. Activity Replacement Offset
            preliminaryAnnualCO2e_g += (activityReplacedOffset_kg * KG_TO_G);
            intermediateCalculations.activityOffset = {
                co2e: (activityReplacedOffset_kg * KG_TO_G),
                description: `Potential savings from AI replacing more carbon-intensive activities (${getOptionLabel('activity_replaced', userAnswers.activity_replaced)}).`
            };

            // 9. Digital Hygiene Multiplier
            preliminaryAnnualCO2e_g *= digitalHygieneMultiplier;
            intermediateCalculations.digitalHygiene = {
                co2e: preliminaryAnnualCO2e_g * (digitalHygieneMultiplier - 1), // Difference due to multiplier
                description: `Final adjustment based on your overall digital hygiene habits (${getOptionLabel('digital_hygiene', userAnswers.digital_hygiene)}).`
            };

            // Final totals
            totalCO2e_g = Math.max(0, preliminaryAnnualCO2e_g);
            totalWater_ml = Math.max(0, preliminaryAnnualWater_ml);
            
            intermediateCalculations.final = {
                co2e: totalCO2e_g,
                water: totalWater_ml,
                description: "Your calculated total annual AI carbon footprint and water consumption."
            };
        }

        // --- Display Results ---
        function displayResults() {
            introScreen.classList.remove('active');
            introScreen.classList.add('hidden');
            questionsContainer.classList.remove('active');
            questionsContainer.classList.add('hidden');

            // Hide guide character on results screen
            guideCharacterContainer.style.display = 'none';

            totalCO2eEl.textContent = (totalCO2e_g / KG_TO_G).toFixed(2) + ' kg'; // Convert to kg
            totalWaterEl.textContent = (totalWater_ml / 1000).toFixed(2) + ' L'; // Convert to Liters

            setFinalDoodleState(totalCO2e_g);

            // Equivalencies
            const co2e_kg = totalCO2e_g / KG_TO_G;
            const water_L = totalWater_ml / 1000;

            // CO2e Equivalents
            const avgCarCO2e_kg_per_km = 0.248; // US EPA: 400g/mile ~ 0.248 kg/km
            co2eEquivCar.innerHTML = `Driving a gasoline car for <strong class="text-emerald-800">${Math.round(co2e_kg / avgCarCO2e_kg_per_km)}</strong> kilometers. (<a href="https://www.epa.gov/greenvehicles/greenhouse-gas-emissions-typical-passenger-vehicle" target="_blank" class="text-emerald-600 hover:underline">EPA</a>)`;

            const avgPhoneChargeCO2e_kg = 0.00734; // 0.02 kWh/charge * 0.367 kgCO2/kWh US avg
            co2eEquivPhone.innerHTML = `Charging your smartphone <strong class="text-emerald-800">${Math.round(co2e_kg / avgPhoneChargeCO2e_kg)}</strong> times. (<a href="https://www.bryceenergyservices.com/2024/10/03/the-total-energy-consumption-of-a-mobile-phone/" target="_blank" class="text-emerald-600 hover:underline">Bryce Energy Services</a>)`;

            // Water Equivalents
            const avgShowerWater_L = 60; // 60 liters per shower
            waterEquivShower.innerHTML = `Taking <strong class="text-emerald-800">${Math.round(water_L / avgShowerWater_L)}</strong> average showers. (<a href="https://en.wikipedia.org/wiki/Residential_water_use_in_the_U.S._and_Canada" target="_blank" class="text-emerald-600 hover:underline">Wikipedia</a>)`;

            const avgFlushWater_L = 6; // 6 liters per flush
            waterEquivFlush.innerHTML = `Flushing a toilet <strong class="text-emerald-800">${Math.round(water_L / avgFlushWater_L)}</strong> times. (<a href="https://www.learnz.org.nz/water172/bg-standard-f/water-use" target="_blank" class="text-emerald-600 hover:underline">LEARNZ</a>)`;

            // --- Small Steps, Big Impact: Relevant Links ---
            tipsList.innerHTML = ''; // Clear previous tips
            const improvementLinks = [
                { label: "Green Software Foundation: Learn about SCI", url: "https://greensoftware.foundation/projects/software-carbon-intensity" },
                { label: "Electricity Maps: Find your grid's carbon intensity", url: "https://www.electricitymaps.com/" },
                { label: "CodeCarbon: Measure code carbon footprint", url: "https://codecarbon.io/" },
                { label: "Google's approach to sustainable AI", url: "https://sustainability.google/progress/projects/ai/" },
                { label: "Tips for sustainable AI prompting", url: "https://altc.alt.ac.uk/blog/2025/05/think-before-you-prompt-reduce-your-ai-carbon-footprint-with-rocks/" }
            ];

            improvementLinks.forEach(link => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="${link.url}" target="_blank" class="text-emerald-600 hover:underline">${link.label}</a>`;
                tipsList.appendChild(li);
            });

            resultsScreen.classList.remove('hidden');
            setTimeout(() => {
                resultsScreen.classList.add('active');
            }, 100);
        }

        // --- LLM Powered Features ---
        async function callGeminiAPI(prompt, spinnerElement) {
            if (spinnerElement) spinnerElement.classList.remove('hidden');
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Canvas will provide this at runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Gemini API response structure unexpected:", result);
                    return "Sorry, I couldn't generate a response. Please try again.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "An error occurred while connecting to the AI. Please try again later.";
            } finally {
                if (spinnerElement) spinnerElement.classList.add('hidden');
            }
        }

        async function generateFootprintExplanation() {
            modalTitle.textContent = 'Your Footprint Explained';
            modalContentArea.innerHTML = '<div class="loading-spinner"></div><p class="text-center mt-4">Generating your personalized footprint analysis...</p>';
            infoModal.style.display = 'flex'; // Show modal

            const totalCO2e_kg = (totalCO2e_g / KG_TO_G).toFixed(2);
            const totalWater_L = (totalWater_ml / 1000).toFixed(2);

            let usageDetails = Object.keys(userAnswers).map(key => {
                const question = questions.find(q => q.id === key);
                return `- ${question.prompt}: ${getOptionLabel(key, userAnswers[key])}`;
            }).join('\n');

            const prompt = `Based on the following AI tool usage profile and calculated annual impacts, provide a personalized, engaging, and informative explanation of the user's AI carbon footprint and water consumption. Focus on breaking down what contributed most to their impact and offer insights into why these factors are significant. Keep it concise, professional, and easy to understand.

User's Annual CO2e: ${totalCO2e_kg} kg
User's Annual Water: ${totalWater_L} L

Usage details:
${usageDetails}
`;
            const response = await callGeminiAPI(prompt, deepDiveSpinner);
            modalContentArea.innerHTML = response;
        }

        async function generateGreenStrategyTips() {
            tipsList.innerHTML = '<div class="loading-spinner"></div><p class="text-center mt-4">Sparking new green strategies...</p>';
            
            let usageDetails = Object.keys(userAnswers).map(key => {
                const question = questions.find(q => q.id === key);
                return `- ${question.prompt}: ${getOptionLabel(key, userAnswers[key])}`;
            }).join('\n');

            const prompt = `Given a user's AI tool usage habits, generate 3-5 actionable and personalized tips to reduce their AI carbon footprint and water consumption. Prioritize tips based on the areas where they likely have the most impact. Consider their current choices and suggest practical changes.

User's AI usage profile:
${usageDetails}

Format the tips as a concise bulleted list. Each tip should start with a bullet point.`;
            
            const response = await callGeminiAPI(prompt, greenStrategySpinner);
            tipsList.innerHTML = ''; // Clear loading spinner
            const tipsArray = response.split('\n').filter(tip => tip.trim().startsWith('*') || tip.trim().startsWith('-')).map(tip => tip.replace(/^[\*\-]\s*/, '').trim());
            tipsArray.forEach(tipText => tipsList.appendChild(createTip(tipText)));
        }

        async function generateQuestionInfo(question) {
            modalTitle.textContent = `About: ${question.prompt}`;
            modalContentArea.innerHTML = '<div class="loading-spinner"></div><p class="text-center mt-4">Getting more info from your guide...</p>';
            infoModal.style.display = 'flex';

            const prompt = `Explain the following AI carbon footprint quiz question in more detail, providing context on why this factor is important for calculating environmental impact. Also, elaborate on the different options a user might choose for this question and what each choice implies for their footprint.

Question: "${question.full_prompt}"
Options: ${question.options ? question.options.map(o => `${o.label}: ${o.desc}`).join('; ') : `Min: ${question.min}, Max: ${question.max}, Steps: ${question.step}`}

Keep the explanation engaging and easy to understand, as if a friendly expert is talking to the user.`;

            const response = await callGeminiAPI(prompt, null); // No dedicated spinner for this small modal
            modalContentArea.innerHTML = response;
        }

        function showCalculationExplanation() {
            modalTitle.textContent = 'How Your Footprint is Calculated';
            modalContentArea.innerHTML = `
                <p class="mb-4">Your annual AI carbon footprint and water consumption are derived from a combination of your answers. Here's a breakdown:</p>
                <div class="space-y-4 text-left">
            `;

            let currentCo2e = 0;
            let currentWater = 0;

            const calculationStepsOrder = [
                'chatbot', 'creative', 'coding', 'device', 'alwaysOn', 'embodiedCarbon', 'activityOffset', 'digitalHygiene'
            ];

            calculationStepsOrder.forEach(stepKey => {
                const step = intermediateCalculations[stepKey];
                if (step) {
                    const stepCo2e = step.co2e || 0;
                    const stepWater = step.water || 0;
                    const signCo2e = stepCo2e >= 0 ? '+' : '';
                    const signWater = stepWater >= 0 ? '+' : '';

                    let co2eChangeText = `${signCo2e}${(stepCo2e / KG_TO_G).toFixed(3)} kg CO2e`;
                    let waterChangeText = `${signWater}${(stepWater / 1000).toFixed(3)} L Water`;

                    if (stepKey === 'digitalHygiene') { // Special case for multiplier
                        const multiplierVal = questions.find(q => q.id === 'digital_hygiene').get_value(userAnswers['digital_hygiene']);
                        co2eChangeText = `Multiplied by ${multiplierVal} (from ${step.co2e >= 0 ? 'increase' : 'decrease'})`;
                        waterChangeText = `Multiplied by ${multiplierVal}`;
                    } else if (stepKey === 'activityOffset') {
                         co2eChangeText = `${(stepCo2e / KG_TO_G).toFixed(3)} kg CO2e (Offset)`;
                         waterChangeText = `N/A for water`;
                    }
                    
                    modalContentArea.innerHTML += `
                        <div class="bg-stone-50 p-3 rounded-lg shadow-sm">
                            <h4 class="font-semibold text-emerald-700 text-base">${step.description}</h4>
                            <p class="text-sm text-stone-600 mt-1">
                                CO2e impact from this step: ${co2eChangeText} <br>
                                Water impact from this step: ${waterChangeText}
                            </p>
                        </div>
                    `;
                }
            });

            modalContentArea.innerHTML += `
                <div class="mt-6 p-4 bg-emerald-100 rounded-lg shadow font-bold text-base">
                    <p>Final Annual CO2e: ${(totalCO2e_g / KG_TO_G).toFixed(2)} kg</p>
                    <p>Final Annual Water: ${(totalWater_ml / 1000).toFixed(2)} L</p>
                </div>
                </div>
            `;
            infoModal.style.display = 'flex';
        }

        // --- Guide Character Movement ---
        let mouseX = 0;
        let mouseY = 0;
        let charX = window.innerWidth - 100; // Start right
        let charY = window.innerHeight - 100; // Start bottom

        function animateCharacter() {
            const dx = mouseX - (charX + guideCharacterContainer.offsetWidth / 2);
            const dy = mouseY - (charY + guideCharacterContainer.offsetHeight / 2);
            
            charX += dx * 0.05; // Adjust speed
            charY += dy * 0.05;

            // Ensure character stays within bounds
            charX = Math.max(20, Math.min(window.innerWidth - guideCharacterContainer.offsetWidth - 20, charX));
            charY = Math.max(20, Math.min(window.innerHeight - guideCharacterContainer.offsetHeight - 20, charY));

            guideCharacterContainer.style.transform = `translate(${charX - (window.innerWidth - guideCharacterContainer.offsetWidth - 20)}px, ${charY - (window.innerHeight - guideCharacterContainer.offsetHeight - 20)}px) scale(1)`; // Keep original scale logic
            
            requestAnimationFrame(animateCharacter);
        }

        document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        // Start animation loop after initial positioning
        animateCharacter();


        // --- Event Listeners ---
        startJourneyBtn.addEventListener('click', () => {
            introScreen.classList.remove('active');
            introScreen.classList.add('slide-out');
            setTimeout(() => {
                introScreen.classList.add('hidden');
                introScreen.remove();
                questionsContainer.classList.remove('hidden');
                renderQuestion(questions[currentQuestionIndex]);
                guideCharacterContainer.style.display = 'block'; // Show character
            }, 500);
        });

        restartJourneyBtn.addEventListener('click', () => {
            userAnswers = {};
            currentQuestionIndex = 0;
            totalCO2e_g = 0;
            totalWater_ml = 0;
            intermediateCalculations = {}; // Clear calculations

            resultsScreen.classList.remove('active');
            resultsScreen.classList.add('slide-out');
            setTimeout(() => {
                resultsScreen.classList.add('hidden');
                // Re-add intro screen content (needs to be created dynamically as it was removed)
                const newIntro = document.createElement('div');
                newIntro.id = 'intro-screen';
                newIntro.className = 'question-section active text-center';
                newIntro.innerHTML = `
                    <h2 class="text-4xl font-extrabold text-emerald-700 mb-6">AI Footprint Journey</h2>
                    <div class="doodle-container">
                        <svg id="ai-sprout-doodle" viewBox="0 0 100 100" class="w-full h-full">
                            <circle id="sprout-pot" cx="50" cy="90" r="15" fill="#a8a29e" stroke="#78716c" stroke-width="2"/>
                            <path id="sprout-stem" d="M50 75 Q45 50 50 30 Q55 50 50 75" fill="#a8a29e" stroke="#78716c" stroke-width="2"/>
                            <circle id="sprout-core" cx="50" cy="30" r="5" fill="#4ade80" stroke="#16a34a" stroke-width="1"/>
                            <g id="sprout-leaves-group">
                                <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(0 50 30) scale(0)"/>
                                <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(72 50 30) scale(0)"/>
                                <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(144 50 30) scale(0)"/>
                                <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(216 50 30) scale(0)"/>
                                <path class="sprout-leaf" d="M50 30 Q40 20 45 15 Q50 10 55 15 Q60 20 50 30" fill="#4ade80" stroke="#16a34a" stroke-width="1" transform="rotate(288 50 30) scale(0)"/>
                            </g>
                            <circle class="sprout-spark" cx="60" cy="20" r="2" fill="yellow"/>
                            <circle class="sprout-spark" cx="40" cy="25" r="2" fill="orange"/>
                        </svg>
                    </div>
                    <p class="text-lg leading-relaxed text-stone-700 mb-8">Ever wondered about the hidden footsteps of your digital companions? Let's uncover your AI Footprint!</p>
                    <button id="start-journey-clone" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-all duration-300 transform hover:scale-105">
                        Start Journey!
                    </button>
                `;
                document.getElementById('calculator-container').prepend(newIntro);
                
                // Attach event listener to the new start button
                newIntro.querySelector('#start-journey-clone').addEventListener('click', () => {
                    newIntro.classList.remove('active');
                    newIntro.classList.add('slide-out');
                    setTimeout(() => {
                        newIntro.classList.add('hidden');
                        newIntro.remove();
                        questionsContainer.innerHTML = ''; // Clear previous questions
                        questionsContainer.classList.remove('hidden');
                        renderQuestion(questions[currentQuestionIndex]);
                        guideCharacterContainer.style.display = 'block'; // Show character
                    }, 500);
                });
                
                questionsContainer.innerHTML = ''; // Clear any residual questions
                questionsContainer.classList.add('hidden'); // Hide until start is clicked
                guideCharacterContainer.style.display = 'none'; // Hide character on restart until new journey begins
                updateDoodle(0); // Reset doodle to healthy state
            }, 500);
        });

        showCalcModalBtn.addEventListener('click', showCalculationExplanation); // New button event listener
        deepDiveBtn.addEventListener('click', generateFootprintExplanation);
        greenStrategyBtn.addEventListener('click', generateGreenStrategyTips);

        modalCloseButton.addEventListener('click', () => infoModal.style.display = 'none');
        window.addEventListener('click', (event) => {
            if (event.target == infoModal) {
                infoModal.style.display = 'none';
            }
        });

        // Guide Character Info Button
        guideCharacterInfoBtn.addEventListener('click', () => {
            if (currentQuestionIndex < questions.length) {
                generateQuestionInfo(questions[currentQuestionIndex]);
            } else {
                // If on results page, maybe a general info about AI carbon footprint?
                // For now, let's just make it do nothing or show a "No specific question info here"
                modalTitle.textContent = "AI Guide Insights";
                modalContentArea.innerHTML = "<p>I'm here to help with the questions! On the results page, I don't have specific question info, but you can use the 'Deep Dive' or 'Green Strategy' buttons for more insights!</p>";
                infoModal.style.display = 'flex';
            }
        });

        // Initialize doodle on page load
        updateDoodle(0);
    </script>
</body>
</html>
